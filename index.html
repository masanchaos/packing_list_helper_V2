<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æ‹–æ‹½åˆ†ç®±å·¥å…· (V93 - åŒ¯å‡ºæ ¼å¼å„ªåŒ–ç‰ˆ)</title>
    <style>
        /* --- å…¨å±€èˆ‡ä½ˆå±€ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Microsoft JhengHei', sans-serif; display: flex; height: 100vh; margin: 0; background-color: #f4f7f6; }
        .container { display: flex; width: 100%; padding: 20px; gap: 20px; }
        .panel { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #item-pool-container { flex: 1; }
        #bin-area-container { flex: 2; }
        h2 { text-align: center; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin: 20px; }
        
        /* --- æ§åˆ¶é … --- */
        .controls { padding: 20px; border-bottom: 2px solid #eee; }
        textarea { width: calc(100% - 22px); height: 100px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; font-size: 14px; }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; }
        button, .button-label { display: inline-block; padding: 10px 15px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; font-size: 16px; transition: background-color 0.2s; text-align: center;}
        .button-label:hover, button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a77c81; cursor: not-allowed; }
        
        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        #mode-switch-btn { background-color: #6610f2; }
        #mode-switch-btn:hover { background-color: #520dc2; }
        #mode-switch-btn.inbound-mode { background-color: #d63384; }
        #mode-switch-btn.inbound-mode:hover { background-color: #b02a6b; }

        #export-btn { background-color: #28a745; }
        #export-btn:hover { background-color: #218838; }
        #export-a4-pdf-btn { background-color: #17a2b8; }
        #export-a4-pdf-btn:hover { background-color: #138496; }
        #export-a5-pdf-btn { background-color: #fd7e14; }
        #export-a5-pdf-btn:hover { background-color: #e86a02; }
        #export-thermal-pdf-btn { background-color: #6f42c1; }
        #export-thermal-pdf-btn:hover { background-color: #5a359a; }
        #clear-data-btn { background-color: #dc3545; }
        #clear-data-btn:hover { background-color: #c82333; }
        #quick-add-bins-btn { background-color: #20c997; }
        #quick-add-bins-btn:hover { background-color: #1baa80; }

        /* --- åˆ—è¡¨èˆ‡è¼¸å…¥æ¡† --- */
        .list-header { padding: 0 20px; }
        .list-header h2, #bin-area-title { display: flex; justify-content: space-between; align-items: center; }
        .item-count { background-color: #6c757d; color: white; font-size: 14px; padding: 2px 8px; border-radius: 10px; }
        
        /* çµ±ä¸€è¼¸å…¥æ¡†æ¨£å¼ */
        #search-box, #scan-input, .order-input input, .command-group input { width: calc(100% - 22px); padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; margin-bottom: 10px; }
        
        /* æƒæå°ˆç”¨æ¡†ç‰¹åˆ¥æ¨£å¼ */
        #scan-input { border: 2px solid #ffc107; background-color: #fffbf2; }
        #scan-input:focus { border-color: #fd7e14; outline: none; box-shadow: 0 0 5px rgba(253, 126, 20, 0.5); }
        
        .scan-group { padding: 10px 20px 0 20px; background-color: #fff; }
        .scan-group label { font-weight: bold; color: #d63384; display: block; margin-bottom: 5px; }

        .order-input, .command-group { padding: 20px 20px 0 20px; }
        .order-input label, .command-group label { font-weight: bold; margin-right: 10px; display: block; margin-bottom: 5px;}
        #item-list-content { flex-grow: 1; overflow-y: auto; padding: 20px; border: 2px dashed transparent; transition: border-color 0.2s, background-color 0.2s; }
        #bin-area { flex-grow: 1; overflow-y: auto; padding: 0 20px 20px 20px; }

        /* --- å•†å“èˆ‡ç®±å­é …ç›® --- */
        .item { background-color: #e9f7fd; border: 1px solid #bde0fe; border-radius: 4px; padding: 10px; margin-bottom: 10px; cursor: grab; user-select: none; transition: opacity 0.2s; }
        .item:active { cursor: grabbing; }
        .item.dragging { opacity: 0.5; }
        .item strong { color: #0d6efd; }
        .item .details { font-size: 12px; color: #555; }
        .bin { background-color: #f8f9fa; border: 2px dashed #ccc; border-radius: 8px; padding: 10px; margin-bottom: 20px; min-height: 100px; transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s; }
        .bin h3 { margin: 0 0 10px 0; color: #666; display: flex; justify-content: space-between; align-items: center; }
        .bin-actions { display: flex; align-items: center; gap: 8px; }
        .delete-bin-btn, .lock-bin-btn, .complete-bin-btn { cursor: pointer; font-weight: bold; padding: 2px 5px; border-radius: 4px; transition: background-color 0.2s; }
        .delete-bin-btn { color: #dc3545; }
        .delete-bin-btn:hover { background-color: #f8d7da; }
        .lock-bin-btn, .complete-bin-btn { font-size: 18px; }
        
        /* é–å®šç‹€æ…‹ */
        .bin.locked { border: 2px solid #ffc107; box-shadow: 0 0 15px rgba(255, 193, 7, 0.4); background-color: #fff9e6; }
        
        /* å·²å®Œæˆç‹€æ…‹ */
        .bin.completed { 
            border: 3px solid #28a745 !important; 
            background-color: #d4edda !important; 
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
            position: relative; overflow: hidden;
        }
        .bin.completed::after {
            content: "å·²å®Œæˆ"; position: absolute; bottom: -5px; right: 10px; font-size: 3.5rem; font-weight: 900;
            color: rgba(40, 167, 69, 0.2); transform: rotate(-15deg); pointer-events: none; z-index: 0;
            border: 4px solid rgba(40, 167, 69, 0.2); padding: 5px 20px; border-radius: 10px;
        }
        .bin.completed .item { opacity: 0.7; background-color: rgba(255, 255, 255, 0.6); }

        /* ç®±å­å…§çš„è¼¸å…¥æ¡†æ¨£å¼ */
        .bin .tracking-input, .bin .note-input { 
            width: calc(100% - 22px); margin-bottom: 5px; padding: 5px 10px; 
            border: 1px solid #ddd; border-radius: 4px; position: relative; z-index: 1;
        }
        /* å‚™è¨»æ¬„ä½çš„ç‰¹åˆ¥æ¨£å¼ */
        .bin .note-input {
            font-size: 13px; color: #555; background-color: #fcfcfc; border-style: dotted; margin-bottom: 10px;
        }
        
        .drag-over { background-color: #e2e6ea; border-color: #007bff !important; }
        
        /* --- å½ˆå‡ºè¦–çª— (Modal) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 350px; text-align: center; }
        .modal-content h3 { margin-top: 0; }
        .modal-content input { width: 80%; padding: 8px; margin: 10px 0 20px 0; text-align: center; font-size: 18px; }

        /* --- Toast é€šçŸ¥ --- */
        .toast-notification { position: fixed; bottom: 20px; right: 20px; background-color: #333; color: white; padding: 12px 20px; border-radius: 6px; z-index: 2000; opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        .toast-notification.show { opacity: 1; bottom: 30px; }
        .toast-notification.error { background-color: #dc3545; }
        .toast-notification.success { background-color: #28a745; }

        /* --- é¸æ“‡è¦–çª—æ¨£å¼ --- */
        #choice-list .choice-item {
            padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px;
            margin-bottom: 8px; cursor: pointer; text-align: left; transition: background-color 0.2s;
        }
        #choice-list .choice-item:hover { background-color: #f0f8ff; }
        #choice-list .choice-item .details { font-size: 12px; color: #555; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="item-pool-container" class="panel">
            <div class="order-input"><label for="order-number-input">è¨‚å–®è™Ÿç¢¼:</label><input type="text" id="order-number-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æœ¬æ¬¡ä½œæ¥­çš„è¨‚å–®è™Ÿç¢¼"></div>
            <div class="controls">
                <textarea id="data-input" placeholder="1. åœ¨æ­¤è²¼ä¸Šå•†å“è³‡æ–™..."></textarea>
                <div class="button-group">
                    <button id="mode-switch-btn">ç›®å‰æ¨¡å¼ï¼šå‡ºè²¨æ¨¡å¼</button>
                    <button id="parse-btn">è§£æè³‡æ–™</button>
                    <label for="import-csv-input" class="button-label" style="background-color:#ffc107; color:#212529;">é‚„åŸCSVå‚™ä»½</label>
                    <input type="file" id="import-csv-input" accept=".csv, text/csv" style="display: none;">
                    <button id="manual-add-btn" style="background-color: #17a2b8; display: none;">æ‰‹å‹•æ–°å¢å•†å“</button>
                    <button id="clear-data-btn">æ¸…é™¤å…¨éƒ¨è³‡æ–™</button>
                </div>
            </div>

            <div class="scan-group">
                <label for="scan-input">ğŸ“¦ å•†å“æƒæå°ˆç”¨ (Enter ç¢ºèª):</label>
                <input type="text" id="scan-input" placeholder="åœ¨æ­¤æƒææ¢ç¢¼ï¼šé–å®šæ™‚å…¥ç®±ï¼Œæœªé–å®šæ™‚æ–°å¢..." autocomplete="off">
            </div>

            <div class="command-group"><label for="command-input">å¿«é€ŸæŒ‡ä»¤:</label><div style="display:flex; gap: 10px;">
                <input type="text" id="command-input" placeholder="è© æ•¸ [ä¾†æºç®±] å»å‘ç®±(0=å¾…åˆ†ç®±å€)" style="margin-bottom:0; flex-grow:1;" title="ç¯„ä¾‹:&#10;å¾å¾…åˆ†ç®±å€ç§»å‡º: 'å•†å“A 5 1' (5å€‹å•†å“Aç§»åˆ°ç¬¬1ç®±)&#10;å¾ç®±å­ç§»å›å¾…åˆ†ç®±å€: 'å•†å“A 3 2 0' (3å€‹å•†å“Aå¾ç¬¬2ç®±ç§»å›)&#10;ç®±å­ä¹‹é–“ç§»å‹•: 'å•†å“A 2 1 3' (2å€‹å•†å“Aå¾ç¬¬1ç®±ç§»åˆ°ç¬¬3ç®±)">
                <button id="execute-command-btn">åŸ·è¡Œ</button>
            </div></div>
            <div class="list-header">
                <h2 id="pool-title">å¾…åˆ†ç®±å€</h2>
                <input type="text" id="search-box" placeholder="ğŸ” åœ¨æ­¤è¼¸å…¥é—œéµå­—ã€Œç¯©é¸ã€åˆ—è¡¨..." style="margin: 0 20px 10px 20px; width: calc(100% - 40px);">
            </div>
            <div id="item-list-content"></div>
        </div>
        <div id="bin-area-container" class="panel">
            <div class="controls" id="bin-controls">
                <div class="button-group">
                    <button id="add-bin-btn">æ–°å¢ç®±å­</button>
                    <button id="quick-add-bins-btn">å¿«é€Ÿç”Ÿæˆå¤šç®±</button>
                    <button id="export-btn">åŒ¯å‡º CSV</button>
                    <button id="export-a4-pdf-btn">åŒ¯å‡º PDF (A4ç¸½è¡¨)</button>
                    <button id="export-a5-pdf-btn">åŒ¯å‡º PDF (A5ç®±è²¼)</button>
                    <button id="export-thermal-pdf-btn">åŒ¯å‡º ç†±æ„Ÿç´™ (10x15)</button>
                </div>
            </div>
            <div id="bin-area-title-wrapper"></div>
            <div id="bin-area" class="bin-list"></div>
        </div>
    </div>
    <div id="quantity-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">ç¢ºèªæ•¸é‡</h3>
            <p>è¦å°‡å¤šå°‘æ•¸é‡çš„ "<span id="modal-item-name"></span>" æ”¾å…¥æ­¤ç®±ï¼Ÿ</p>
            <input type="number" id="modal-quantity-input" min="1">
            <div class="button-group" style="justify-content: center;">
                <button id="modal-confirm-btn">ç¢ºèª</button>
                <button id="modal-cancel-btn" style="background-color: #6c757d;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <div id="choice-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>ç™¼ç¾å¤šå€‹ç¬¦åˆé …ç›®</h3>
            <p>è«‹é¸æ“‡æ‚¨è¦æ“ä½œçš„ç¢ºåˆ‡å•†å“ï¼š</p>
            <div id="choice-list" style="max-height: 200px; overflow-y: auto; margin: 15px 0;"></div>
            <button id="choice-cancel-btn" style="background-color: #6c757d; margin-top: 10px; width: 100%;">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="manual-add-modal" class="modal-overlay">
        <div class="modal-content" style="width: 400px; text-align: left;">
            <h3>æ–°å¢å•†å“ (å…¥å€‰æ¨¡å¼)</h3>
            <label for="new-item-code">å•†å“ç·¨è™Ÿ:</label>
            <input type="text" id="new-item-code" style="width: 100%; margin-bottom: 10px;" placeholder="è¼¸å…¥ç·¨è™Ÿ">
            <label for="new-item-name">å•†å“åç¨±:</label>
            <input type="text" id="new-item-name" style="width: 100%; margin-bottom: 10px;" placeholder="è¼¸å…¥åç¨±">
            <label for="new-item-qty">æ•¸é‡:</label>
            <input type="number" id="new-item-qty" style="width: 100%; margin-bottom: 20px;" min="1" value="1">
            <div class="button-group" style="justify-content: center;">
                <button id="manual-add-confirm-btn">ç¢ºèªæ–°å¢</button>
                <button id="manual-add-cancel-btn" style="background-color: #6c757d;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

<script>
    // --- DOM å…ƒç´ ç²å– ---
    const orderNumberInput = document.getElementById('order-number-input');
    const dataInput = document.getElementById('data-input');
    const parseBtn = document.getElementById('parse-btn');
    const modeSwitchBtn = document.getElementById('mode-switch-btn'); 
    const addBinBtn = document.getElementById('add-bin-btn');
    const clearDataBtn = document.getElementById('clear-data-btn');
    const quickAddBinsBtn = document.getElementById('quick-add-bins-btn');
    const itemListContent = document.getElementById('item-list-content');
    const binArea = document.getElementById('bin-area');
    const searchBox = document.getElementById('search-box');
    const scanInput = document.getElementById('scan-input'); // æƒæè¼¸å…¥æ¡†
    const commandInput = document.getElementById('command-input');
    const executeCommandBtn = document.getElementById('execute-command-btn');
    const poolTitle = document.getElementById('pool-title');
    const binAreaTitleWrapper = document.getElementById('bin-area-title-wrapper');
    const binAreaTitle = document.createElement('h2');
    binAreaTitle.id = 'bin-area-title';
    binAreaTitleWrapper.appendChild(binAreaTitle);
    const quantityModal = document.getElementById('quantity-modal');
    const modalItemName = document.getElementById('modal-item-name');
    const modalQuantityInput = document.getElementById('modal-quantity-input');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const choiceModal = document.getElementById('choice-modal');
    const choiceList = document.getElementById('choice-list');
    const choiceCancelBtn = document.getElementById('choice-cancel-btn');
    const importCsvInput = document.getElementById('import-csv-input');
    
    // --- æ‰‹å‹•æ–°å¢åŠŸèƒ½ DOM ---
    const manualAddBtn = document.getElementById('manual-add-btn');
    const manualAddModal = document.getElementById('manual-add-modal');
    const manualAddConfirmBtn = document.getElementById('manual-add-confirm-btn');
    const manualAddCancelBtn = document.getElementById('manual-add-cancel-btn');
    const newItemCodeInput = document.getElementById('new-item-code');
    const newItemNameInput = document.getElementById('new-item-name');
    const newItemQtyInput = document.getElementById('new-item-qty');
    
    let AppState = { pool: new Map(), bins: new Map(), lockedBinId: null };
    let binCounter = 0;
    let currentSearchTerm = '';
    let modalCallback = null;
    let currentMode = 'outbound'; // 'outbound' (å‡ºè²¨) or 'inbound' (å…¥å€‰)

    // --- æ ¸å¿ƒæ¸²æŸ“å‡½å¼ ---
    function render() {
        itemListContent.innerHTML = '';
        const searchKeywords = currentSearchTerm.split(/[,ã€\s]+/).filter(Boolean);
        const itemsToRender = Array.from(AppState.pool.values()).filter(item => {
            if (searchKeywords.length === 0) return true;
            const itemText = `${item.name} ${item.code} ${item.barcode}`.toLowerCase();
            return searchKeywords.some(keyword => itemText.includes(keyword));
        });
        itemsToRender.forEach(item => { itemListContent.appendChild(createItemElement(item, 'pool')); });
        binArea.innerHTML = '';
        const sortedBins = Array.from(AppState.bins.entries()).sort((a, b) => {
            const numA = parseInt(a[0].replace('bin-', ''));
            const numB = parseInt(b[0].replace('bin-', ''));
            return numA - numB;
        });

        for(const [binId, binData] of sortedBins) {
            const binEl = document.createElement('div');
            binEl.className = 'bin';
            if (binId === AppState.lockedBinId) binEl.classList.add('locked');
            if (binData.completed) binEl.classList.add('completed');
            binEl.dataset.binId = binId;
            const title = document.createElement('h3');
            const binNameSpan = document.createElement('span');
            binNameSpan.textContent = binData.name;
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'bin-actions';
            
            const completeBtn = document.createElement('span');
            completeBtn.className = 'complete-bin-btn';
            completeBtn.title = 'æ¨™ç¤ºç‚ºå·²å®Œæˆ';
            completeBtn.textContent = 'âœ…';
            
            const lockBtn = document.createElement('span');
            lockBtn.className = 'lock-bin-btn';
            lockBtn.title = 'é–å®šæ­¤ç®±ä»¥ä¾¿å¿«é€Ÿæƒæå…¥ç®±';
            lockBtn.textContent = 'ğŸ”’';
            
            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'delete-bin-btn';
            deleteBtn.title = 'åˆªé™¤æ­¤ç®±';
            deleteBtn.textContent = '[X]';
            
            actionsDiv.appendChild(completeBtn);
            actionsDiv.appendChild(lockBtn);
            actionsDiv.appendChild(deleteBtn);
            title.appendChild(binNameSpan);
            title.appendChild(actionsDiv);
            
            const trackingInput = document.createElement('input');
            trackingInput.type = 'text';
            trackingInput.className = 'tracking-input';
            trackingInput.placeholder = 'è«‹åœ¨æ­¤è¼¸å…¥é‹å–®è™Ÿ...';
            trackingInput.value = binData.tracking;
            trackingInput.addEventListener('input', (e) => { 
                AppState.bins.get(binId).tracking = e.target.value; 
                saveStateToLocalStorage();
            });

            // --- æ–°å¢ï¼šå‚™è¨»æ¬„ä½ ---
            const noteInput = document.createElement('input');
            noteInput.type = 'text';
            noteInput.className = 'note-input';
            noteInput.placeholder = 'å‚™è¨» (é¸å¡«)...';
            noteInput.value = binData.note || ''; // å¦‚æœæ²’æœ‰å‚™è¨»å‰‡ç‚ºç©º
            noteInput.addEventListener('input', (e) => {
                AppState.bins.get(binId).note = e.target.value;
                saveStateToLocalStorage();
            });

            binEl.appendChild(title);
            binEl.appendChild(trackingInput);
            binEl.appendChild(noteInput); // å°‡å‚™è¨»æ¬„ä½åŠ å…¥ DOM
            
            binData.items.forEach(item => {
                binEl.appendChild(createItemElement(item, binId));
            });
            binArea.appendChild(binEl);
        }
        updateCounts();
    }
    
    // --- æ ¸å¿ƒèˆ‡è¼”åŠ©å‡½å¼ ---
    function createItemElement(item, source) {
        const itemEl = document.createElement('div');
        itemEl.className = 'item';
        itemEl.draggable = true;
        itemEl.dataset.code = item.code;
        itemEl.dataset.source = source;
        itemEl.innerHTML = `<strong>${item.name}</strong><div class="details">(ç·¨è™Ÿ: ${item.code}, æ¢ç¢¼: ${item.barcode}, æ•¸é‡: ${item.quantity})</div>`;
        return itemEl;
    }

    function updateCounts() {
        const poolTotal = Array.from(AppState.pool.values()).reduce((sum, item) => sum + (item.quantity || 0), 0);
        poolTitle.innerHTML = `å¾…åˆ†ç®±å€ <span class="item-count">${poolTotal}</span>`;
        let binsTotal = 0;
        AppState.bins.forEach((binData, binId) => {
            const binTotal = Array.from(binData.items.values()).reduce((sum, item) => sum + (item.quantity || 0), 0);
            binsTotal += binTotal;
            const binEl = binArea.querySelector(`.bin[data-bin-id="${binId}"]`);
            if (binEl) {
                const titleEl = binEl.querySelector('h3 > span:first-child');
                if (titleEl){
                    titleEl.innerHTML = `${binData.name} <span class="item-count">${binTotal}</span>`;
                }
            }
        });
        binAreaTitle.innerHTML = `åˆ†ç®±å·¥ä½œå€ <span class="item-count">${binsTotal}</span>`;
    }

    function moveItem(itemCode, sourceId, targetId, quantityToMove) {
        const sourceMap = (sourceId === 'pool') ? AppState.pool : AppState.bins.get(sourceId)?.items;
        const targetMap = (targetId === 'pool') ? AppState.pool : AppState.bins.get(targetId)?.items;
        if (!sourceMap || !targetMap || !sourceMap.has(itemCode)) { return; }
        const itemToMove = sourceMap.get(itemCode);
        const existingTargetItem = targetMap.get(itemCode);
        if (existingTargetItem) {
            existingTargetItem.quantity += quantityToMove;
        } else {
            targetMap.set(itemCode, { ...itemToMove, quantity: quantityToMove });
        }
        itemToMove.quantity -= quantityToMove;
        if (itemToMove.quantity <= 0) {
            sourceMap.delete(itemCode);
        }
        render();
        saveStateToLocalStorage();
    }
    
    function returnItemsToPool(items) {
        items.forEach(itemToReturn => {
            const existingPoolItem = AppState.pool.get(itemToReturn.code);
            if (existingPoolItem) {
                existingPoolItem.quantity += itemToReturn.quantity;
            } else {
                AppState.pool.set(itemToReturn.code, { ...itemToReturn });
            }
        });
    }

    function reIndexBins() {
        const newBins = new Map();
        let newCounter = 1;
        const sortedBinArray = Array.from(AppState.bins.entries()).sort((a, b) => parseInt(a[0].split('-')[1]) - parseInt(b[0].split('-')[1]));
        sortedBinArray.forEach(([oldBinId, binData]) => {
            const newBinId = `bin-${newCounter}`;
            binData.name = `ç¬¬ ${newCounter} ç®±`;
            if (AppState.lockedBinId === oldBinId) {
                AppState.lockedBinId = newBinId;
            }
            newBins.set(newBinId, binData);
            newCounter++;
        });
        AppState.bins = newBins;
        binCounter = newBins.size;
    }
    
    function showQuantityModal(item, sourceId, targetId) {
        modalItemName.textContent = item.name;
        modalQuantityInput.value = item.quantity;
        modalQuantityInput.max = item.quantity;
        quantityModal.style.display = 'flex';
        modalQuantityInput.focus();
        modalCallback = (amount) => {
            moveItem(item.code, sourceId, targetId, amount);
            modalCallback = null;
        };
    }

    function hideQuantityModal() {
        quantityModal.style.display = 'none';
        modalCallback = null;
    }

    function showChoiceModal(results, quantityToMove, sourceId, targetId) {
        choiceList.innerHTML = '';
        results.forEach(item => {
            const choiceEl = document.createElement('div');
            choiceEl.className = 'choice-item';
            choiceEl.innerHTML = `<strong>${item.name}</strong><div class="details">(ç·¨è™Ÿ: ${item.code})</div>`;
            choiceEl.addEventListener('click', () => {
                hideChoiceModal();
                const sourceMap = (sourceId === 'pool') ? AppState.pool : AppState.bins.get(sourceId).items;
                const selectedItem = sourceMap.get(item.code);
                if (quantityToMove > selectedItem.quantity) {
                    showToast(`ç§»å‹•æ•¸é‡ (${quantityToMove}) è¶…éæ‰€é¸å•†å“å‰©é¤˜æ•¸é‡ (${selectedItem.quantity})ï¼`, 'error');
                    return;
                }
                moveItem(item.code, sourceId, targetId, quantityToMove);
                showToast(`å·²å°æ‚¨é¸æ“‡çš„ "${item.name}" åŸ·è¡Œæ“ä½œã€‚`, 'success');
            });
            choiceList.appendChild(choiceEl);
        });
        choiceModal.style.display = 'flex';
    }

    function hideChoiceModal() {
        choiceModal.style.display = 'none';
        choiceList.innerHTML = '';
    }

    // --- è§£æé‚è¼¯ ---
    function intelligentParse(rawLines) {
        const poolMap = new Map();
        const dataLines = rawLines.map(line => line.trim()).filter(line => line);
        for (const line of dataLines) {
            const columns = line.split('\t');
            let item = null;
            if (columns.length === 4) {
                const quantity = parseInt(columns[3], 10);
                if (!isNaN(quantity)) {
                    item = { code: columns[0].trim(), barcode: columns[1].trim() || 'NA', name: columns[2].trim(), quantity: quantity };
                }
            } else if (columns.length === 3) {
                const quantity = parseInt(columns[2], 10);
                if (!isNaN(quantity)) {
                    item = { code: columns[0].trim(), barcode: 'NA', name: columns[1].trim(), quantity: quantity };
                }
            }
            if (item && item.code && item.name) {
                if (poolMap.has(item.code)) { poolMap.get(item.code).quantity += item.quantity; } else { poolMap.set(item.code, item); }
            }
        }
        return poolMap;
    }

    function parseInboundData(rawLines) {
        const poolMap = new Map();
        const dataLines = rawLines.map(line => line.trim()).filter(line => line);
        if (dataLines.length % 4 !== 0) { showToast("è­¦å‘Šï¼šå…¥å€‰è³‡æ–™è¡Œæ•¸ä¸æ˜¯4çš„å€æ•¸ï¼Œè§£æå¯èƒ½æœƒä¸å®Œæ•´ï¼", "error"); }
        for (let i = 0; i < dataLines.length; i += 4) {
            if (i + 3 >= dataLines.length) break;
            const code = dataLines[i];
            const name = dataLines[i+1];
            const qtyStr = dataLines[i+2];
            const quantity = parseInt(qtyStr, 10);
            if (code && name && !isNaN(quantity)) {
                if (poolMap.has(code)) { poolMap.get(code).quantity += quantity; } else { poolMap.set(code, { code: code, barcode: 'NA', name: name, quantity: quantity }); }
            }
        }
        return poolMap;
    }

    function clearAllData() {
        if (confirm("æ‚¨ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\né€™å€‹æ“ä½œç„¡æ³•å¾©åŸï¼Œå°‡æœƒæ¸…ç©ºå¾…åˆ†ç®±å€ã€æ‰€æœ‰ç®±å­å’Œè¨‚å–®è™Ÿç¢¼ã€‚")) {
            AppState.pool.clear();
            AppState.bins.clear();
            AppState.lockedBinId = null;
            binCounter = 0;
            orderNumberInput.value = '';
            dataInput.value = '';
            searchBox.value = '';
            currentSearchTerm = '';
            localStorage.removeItem('binningToolState_v72');
            render();
            showToast("æ‰€æœ‰è³‡æ–™å·²æˆåŠŸæ¸…é™¤ã€‚", 'success');
        }
    }

    function quickAddBins() {
        const numStr = prompt("è«‹è¼¸å…¥è¦ä¸€æ¬¡æ–°å¢çš„ç®±å­æ•¸é‡ï¼š", "5");
        if (numStr === null) return;
        const num = parseInt(numStr);
        if (isNaN(num) || num <= 0 || num > 100) {
            showToast("è«‹è¼¸å…¥ä¸€å€‹ 1 åˆ° 100 ä¹‹é–“çš„æœ‰æ•ˆæ•¸å­—ã€‚", "error");
            return;
        }
        for (let i = 0; i < num; i++) {
            binCounter++;
            const binId = `bin-${binCounter}`;
            AppState.bins.set(binId, { name: `ç¬¬ ${binCounter} ç®±`, tracking: '', items: new Map(), completed: false, note: '' });
        }
        render();
        saveStateToLocalStorage();
        showToast(`å·²æˆåŠŸæ–°å¢ ${num} å€‹ç®±å­ã€‚`, 'success');
    }

    // --- äº‹ä»¶ç›£è½å™¨ç¶å®š ---
    modeSwitchBtn.addEventListener('click', () => {
        if (currentMode === 'outbound') {
            currentMode = 'inbound';
            modeSwitchBtn.textContent = 'ç›®å‰æ¨¡å¼ï¼šå…¥å€‰æ¨¡å¼';
            modeSwitchBtn.classList.add('inbound-mode');
            dataInput.placeholder = '1. åœ¨æ­¤è²¼ä¸Šå…¥å€‰è³‡æ–™ (æ ¼å¼ï¼šç·¨è™Ÿ\\nåç¨±\\næ•¸é‡\\næ•¸é‡2)...';
            manualAddBtn.style.display = 'inline-block';
            showToast('å·²åˆ‡æ›è‡³ã€å…¥å€‰æ¨¡å¼ã€‘', 'info');
        } else {
            currentMode = 'outbound';
            modeSwitchBtn.textContent = 'ç›®å‰æ¨¡å¼ï¼šå‡ºè²¨æ¨¡å¼';
            modeSwitchBtn.classList.remove('inbound-mode');
            dataInput.placeholder = '1. åœ¨æ­¤è²¼ä¸Šå•†å“è³‡æ–™...';
            manualAddBtn.style.display = 'none';
            showToast('å·²åˆ‡æ›è‡³ã€å‡ºè²¨æ¨¡å¼ã€‘', 'info');
        }
    });

    parseBtn.addEventListener('click', () => {
        const rawLines = dataInput.value.trim().split('\n');
        if (rawLines.length === 0 || (rawLines.length === 1 && rawLines[0] === '')) { showToast("è«‹å…ˆè¼¸å…¥è³‡æ–™ï¼", "error"); return; }
        let parsedMap;
        if (currentMode === 'inbound') { parsedMap = parseInboundData(rawLines); } else { parsedMap = intelligentParse(rawLines); }
        if (parsedMap.size > 0) {
            AppState.pool = parsedMap;
            AppState.bins.clear();
            AppState.lockedBinId = null;
            binCounter = 0;
            render();
            dataInput.value = '';
            showToast(`è³‡æ–™è§£ææˆåŠŸï¼(æ¨¡å¼ï¼š${currentMode === 'inbound' ? 'å…¥å€‰' : 'å‡ºè²¨'})`, 'success');
            saveStateToLocalStorage();
        } else {
            showToast("è§£æå¤±æ•—ï¼è«‹æª¢æŸ¥è³‡æ–™æ ¼å¼æ˜¯å¦ç¬¦åˆç•¶å‰æ¨¡å¼ã€‚", 'error');
        }
    });

    addBinBtn.addEventListener('click', () => {
        binCounter++;
        const binId = `bin-${binCounter}`;
        AppState.bins.set(binId, { name: `ç¬¬ ${binCounter} ç®±`, tracking: '', items: new Map(), completed: false, note: '' });
        render();
        saveStateToLocalStorage();
    });
    clearDataBtn.addEventListener('click', clearAllData);
    quickAddBinsBtn.addEventListener('click', quickAddBins);
    
    // --- æœå°‹æ¡†é‚è¼¯ (åƒ…ç¯©é¸) ---
    searchBox.addEventListener('input', () => {
        const searchTerm = searchBox.value.trim();
        currentSearchTerm = searchTerm.toLowerCase();
        render();
    });

    // --- æƒææ¡†é‚è¼¯ (å…¥ç®±æˆ–æ–°å¢) ---
    scanInput.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;
        e.preventDefault(); 
        const codeToScan = scanInput.value.trim();
        if (!codeToScan) return;

        if (AppState.lockedBinId) {
            const lockedBin = AppState.bins.get(AppState.lockedBinId);
            if (lockedBin) {
                const matchedItem = Array.from(AppState.pool.values()).find(
                    item => item.code === codeToScan || item.barcode === codeToScan
                );
                if (matchedItem) {
                    moveItem(matchedItem.code, 'pool', AppState.lockedBinId, 1);
                    showToast(`å·²ç§»å‹• 1 å€‹ "${matchedItem.name}" è‡³ ${lockedBin.name}`, 'success');
                } else {
                    showToast(`åœ¨å¾…åˆ†ç®±å€æ‰¾ä¸åˆ°å•†å“ (ä»£ç¢¼: ${codeToScan})`, 'error');
                }
            }
        } else {
            let existingItem = AppState.pool.get(codeToScan);
            if (!existingItem) {
                existingItem = Array.from(AppState.pool.values()).find(item => item.barcode === codeToScan);
            }

            if (existingItem) {
                existingItem.quantity += 1;
                showToast(`å•†å“ "${existingItem.name}" æ•¸é‡ +1 (ç›®å‰: ${existingItem.quantity})`, 'success');
            } else {
                const newItem = {
                    code: codeToScan,
                    barcode: 'NA',
                    name: `æƒææ–°å¢å•†å“ (${codeToScan})`,
                    quantity: 1
                };
                AppState.pool.set(codeToScan, newItem);
                showToast(`å·²æ–°å¢å•†å“ï¼š${newItem.name}`, 'success');
            }
            render();
            saveStateToLocalStorage();
        }
        scanInput.value = '';
    });

    binArea.addEventListener('click', (e) => {
        const binEl = e.target.closest('.bin');
        if (!binEl) return;
        const binId = binEl.dataset.binId;
        const binData = AppState.bins.get(binId);
        if (!binData) return;

        if (e.target.classList.contains('delete-bin-btn')) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${binData.name}ã€å—ï¼Ÿ\n(ç®±å…§æ‰€æœ‰å•†å“å°‡æœƒè¢«ç§»å›å¾…åˆ†ç®±å€)`)) {
                if (binData.items.size > 0) { returnItemsToPool(Array.from(binData.items.values())); }
                if (AppState.lockedBinId === binId) { AppState.lockedBinId = null; }
                AppState.bins.delete(binId);
                reIndexBins();
                render();
                saveStateToLocalStorage();
            }
        } else if (e.target.classList.contains('lock-bin-btn')) {
            if (AppState.lockedBinId === binId) {
                AppState.lockedBinId = null;
                showToast('ç®±å­å·²è§£é–', 'info');
            } else {
                AppState.lockedBinId = binId;
                showToast(`${binData.name} å·²é–å®šï¼è«‹ä½¿ç”¨ä¸Šæ–¹é»ƒè‰²æƒææ¡†å…¥ç®±ã€‚`, 'success');
                scanInput.focus();
            }
            render();
            saveStateToLocalStorage();
        } else if (e.target.classList.contains('complete-bin-btn')) {
            binData.completed = !binData.completed;
            showToast(binData.completed ? `${binData.name} å·²æ¨™ç¤ºç‚ºå®Œæˆ` : `${binData.name} å·²å–æ¶ˆå®Œæˆæ¨™ç¤º`, 'info');
            render();
            saveStateToLocalStorage();
        }
    });

    // ... (Drag & Drop) ...
    document.addEventListener('dragstart', e => {
        const itemEl = e.target.closest('.item');
        if (itemEl) {
            const itemInfo = { code: itemEl.dataset.code, source: itemEl.dataset.source };
            e.dataTransfer.setData('application/json', JSON.stringify(itemInfo));
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => itemEl.classList.add('dragging'), 0);
        }
    });
    document.addEventListener('dragend', e => { const el = e.target.closest('.item'); if(el) el.classList.remove('dragging'); });
    document.addEventListener('dragover', e => {
        e.preventDefault();
        const targetBin = e.target.closest('.bin');
        const targetPool = e.target.closest('#item-list-content');
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        itemListContent.style.borderColor = 'transparent';
        if (targetBin) { targetBin.classList.add('drag-over'); }
        if (targetPool) { itemListContent.style.borderColor = '#007bff'; }
    });
    document.addEventListener('dragleave', e => {
        const targetBin = e.target.closest('.bin');
        const targetPool = e.target.closest('#item-list-content');
        if(targetBin) targetBin.classList.remove('drag-over');
        if(targetPool) itemListContent.style.borderColor = 'transparent';
    });
    document.addEventListener('drop', e => {
        e.preventDefault();
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        itemListContent.style.borderColor = 'transparent';
        const targetBinEl = e.target.closest('.bin');
        const targetPoolEl = e.target.closest('#item-list-content');
        try {
            const itemInfo = JSON.parse(e.dataTransfer.getData('application/json'));
            if (!itemInfo) return;
            if (targetBinEl && itemInfo.source === 'pool') {
                const targetBinId = targetBinEl.dataset.binId;
                const itemData = AppState.pool.get(itemInfo.code);
                if (!itemData) return;
                if (itemData.quantity > 1) {
                    showQuantityModal(itemData, itemInfo.source, targetBinId);
                } else {
                    moveItem(itemInfo.code, itemInfo.source, targetBinId, 1);
                }
            } 
            else if (targetPoolEl && itemInfo.source !== 'pool') {
                const sourceBinId = itemInfo.source;
                const itemCode = itemInfo.code;
                const sourceBinMap = AppState.bins.get(sourceBinId)?.items;
                if (!sourceBinMap || !sourceBinMap.has(itemCode)) return;
                const itemData = sourceBinMap.get(itemCode);
                moveItem(itemData.code, sourceBinId, 'pool', itemData.quantity);
            }
        } catch (err) { console.error("æ‹–æ›³è³‡æ–™è§£æå¤±æ•—:", err); }
    });
    
    function handleModalConfirm() {
        const amount = parseInt(modalQuantityInput.value);
        const maxAmount = parseInt(modalQuantityInput.max);
        if (amount > 0 && amount <= maxAmount && modalCallback) {
            modalCallback(amount);
            hideQuantityModal();
        } else {
            showToast(`è«‹è¼¸å…¥ 1 åˆ° ${maxAmount} ä¹‹é–“çš„æœ‰æ•ˆæ•¸é‡ï¼`, 'error');
        }
    }
    modalConfirmBtn.addEventListener('click', handleModalConfirm);
    modalQuantityInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleModalConfirm();
        }
    });
    modalCancelBtn.addEventListener('click', hideQuantityModal);
    choiceCancelBtn.addEventListener('click', hideChoiceModal);

    manualAddBtn.addEventListener('click', () => {
        newItemCodeInput.value = '';
        newItemNameInput.value = '';
        newItemQtyInput.value = '1';
        manualAddModal.style.display = 'flex';
        newItemCodeInput.focus();
    });
    manualAddCancelBtn.addEventListener('click', () => { manualAddModal.style.display = 'none'; });
    manualAddConfirmBtn.addEventListener('click', () => {
        const code = newItemCodeInput.value.trim();
        const name = newItemNameInput.value.trim();
        const qty = parseInt(newItemQtyInput.value, 10);
        if (!code || !name) { showToast("è«‹è¼¸å…¥å®Œæ•´çš„ç·¨è™Ÿèˆ‡åç¨±ï¼", "error"); return; }
        if (isNaN(qty) || qty <= 0) { showToast("æ•¸é‡å¿…é ˆå¤§æ–¼ 0ï¼", "error"); return; }
        if (AppState.pool.has(code)) {
            const existingItem = AppState.pool.get(code);
            existingItem.quantity += qty;
            showToast(`å•†å“ ${code} å·²å­˜åœ¨ï¼Œæ•¸é‡å·²å¢åŠ  ${qty}ã€‚`, "success");
        } else {
            const newItem = { code: code, barcode: 'NA', name: name, quantity: qty };
            AppState.pool.set(code, newItem);
            showToast(`å·²æ–°å¢å•†å“ï¼š${name}`, "success");
        }
        render();
        saveStateToLocalStorage();
        manualAddModal.style.display = 'none';
    });
    
    function processCommand(commandText) {
        const tokens = commandText.trim().split(/\s+/).filter(Boolean);
        if (tokens.length < 3) { showToast("æŒ‡ä»¤æ ¼å¼éŒ¯èª¤ï¼è«‹æª¢æŸ¥æ ¼å¼ã€‚", 'error'); return false; }
        let sourceId, targetId, searchTerm, quantityToMove;
        const isNumeric = (str) => str !== null && str.trim() !== '' && !isNaN(str) && !isNaN(parseFloat(str));
        const L1 = tokens[tokens.length - 1];
        const L2 = tokens[tokens.length - 2];
        const L3 = tokens.length >= 4 ? tokens[tokens.length - 3] : null;

        if (tokens.length >= 4 && isNumeric(L1) && isNumeric(L2) && isNumeric(L3)) {
            const fromBinNum = L2; const toBinNum = L1;
            sourceId = `bin-${fromBinNum}`;
            if (toBinNum === '0') { targetId = 'pool'; } else { targetId = `bin-${toBinNum}`; if (!AppState.bins.has(targetId)) { showToast(`æŒ‡ä»¤éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç›®æ¨™ç®±è™Ÿ ${toBinNum}ï¼`, 'error'); return false; } }
            quantityToMove = parseInt(L3); searchTerm = tokens.slice(0, tokens.length - 3).join(' ');
        } else if (isNumeric(L1) && isNumeric(L2)) {
            const toBinNum = L1; sourceId = 'pool'; targetId = `bin-${toBinNum}`;
            if (!AppState.bins.has(targetId)) { showToast(`æŒ‡ä»¤éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ç›®æ¨™ç®±è™Ÿ ${toBinNum}ï¼`, 'error'); return false; }
            quantityToMove = parseInt(L2); searchTerm = tokens.slice(0, tokens.length - 2).join(' ');
        } else { showToast("æŒ‡ä»¤æ ¼å¼ç„¡æ³•è­˜åˆ¥ï¼\nè«‹ä½¿ç”¨: (è© æ•¸ å»å‘ç®±) æˆ– (è© æ•¸ ä¾†æºç®± å»å‘ç®±/0)", "error"); return false; }
        
        const sourceMap = (sourceId === 'pool') ? AppState.pool : AppState.bins.get(sourceId)?.items;
        if (!sourceMap) { showToast(`æŒ‡ä»¤éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä¾†æºã€Œ${sourceId}ã€ï¼`, 'error'); return false; }
        if (isNaN(quantityToMove) || quantityToMove <= 0) { showToast("æŒ‡ä»¤éŒ¯èª¤ï¼šæ•¸é‡å¿…é ˆæ˜¯æ­£æ•´æ•¸ã€‚", 'error'); return false; }
        const searchLower = searchTerm.toLowerCase();
        const results = Array.from(sourceMap.values()).filter(item => item.name.toLowerCase().includes(searchLower) || item.code.toLowerCase().includes(searchLower) || (item.barcode && item.barcode.toLowerCase().includes(searchLower)));
        if (results.length === 0) { showToast(`åœ¨ä¾†æº (${sourceId}) æ‰¾ä¸åˆ°ç¬¦åˆ "${searchTerm}" çš„å•†å“`, 'error'); return false; }
        if (results.length === 1) {
            const targetItem = results[0];
            if (quantityToMove > targetItem.quantity) { showToast(`ç§»å‹•æ•¸é‡ (${quantityToMove}) è¶…éç¾æœ‰æ•¸é‡ (${targetItem.quantity})`, 'error'); return false; }
            moveItem(targetItem.code, sourceId, targetId, quantityToMove);
            showToast(`å·²å°‡ ${quantityToMove} å€‹ "${targetItem.name}" åŸ·è¡Œç§»å‹•ã€‚`, 'success');
            return true;
        }
        if (results.length > 1) { showToast(`ç™¼ç¾ ${results.length} å€‹ç¬¦åˆé …ç›®ï¼Œè«‹é¸æ“‡...`); showChoiceModal(results, quantityToMove, sourceId, targetId); return true; }
        return false;
    }
    executeCommandBtn.addEventListener('click', () => { if (processCommand(commandInput.value)) { commandInput.value = ''; } });
    commandInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); executeCommandBtn.click(); } });

    function setupExports() {
        const exportBtn = document.getElementById('export-btn');
        const exportA4PdfBtn = document.getElementById('export-a4-pdf-btn');
        const exportA5PdfBtn = document.getElementById('export-a5-pdf-btn');
        const exportThermalPdfBtn = document.getElementById('export-thermal-pdf-btn');
        
        function generateExportFilename(extension) {
            const now = new Date();
            const orderNumber = orderNumberInput.value.trim() || 'NoOrder';
            return `${orderNumber}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}_packing_list${extension}`;
        }
        function exportCSV() {
            if (AppState.bins.size === 0) { showToast("æ²’æœ‰ä»»ä½•å·²åˆ†ç®±çš„è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼", "error"); return; }
            const orderNumber = orderNumberInput.value.trim() || 'N/A';
            const binsArray = Array.from(AppState.bins.values());
            const totalBins = binsArray.length;
            
            let csvContent = "\uFEFFè¨‚å–®è™Ÿç¢¼,ç®±è™Ÿ,é‹å–®è™Ÿ,å‚™è¨»,å•†å“ç·¨è™Ÿ,åœ‹éš›æ¢ç¢¼,å“é …åç¨±,æ•¸é‡\n";
            const formatCsvField = (v) => { let s = String(v ?? ''); s = s.replace(/"/g, '""'); return s.search(/("|,|\n)/g) >= 0 ? `"${s}"` : s; };
            
            binsArray.forEach((bin, index) => {
                const note = bin.note || ''; 
                // ä¿®æ”¹ï¼šå‹•æ…‹ç”¢ç”Ÿç®±è™Ÿæ ¼å¼ (å…±Xç®±-ç¬¬Yç®±)
                const binName = `å…±${totalBins}ç®±-ç¬¬${index+1}ç®±`;
                
                if (bin.items.size === 0) { 
                    csvContent += [orderNumber, binName, bin.tracking, note, '', '', 'æ­¤ç®±ç„¡å•†å“', 0].map(formatCsvField).join(',') + "\n"; 
                } else { 
                    bin.items.forEach(item => { 
                        csvContent += [orderNumber, binName, bin.tracking, note, item.code, item.barcode, item.name, item.quantity].map(formatCsvField).join(',') + "\n"; 
                    }); 
                }
            });
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
            link.download = generateExportFilename('.csv'); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        function exportA4PDF() { 
            if (AppState.bins.size === 0 && AppState.pool.size === 0) { showToast("æ²’æœ‰ä»»ä½•è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼", "error"); return; }
            const btn = document.getElementById('export-a4-pdf-btn'); btn.disabled = true; btn.textContent = 'æº–å‚™é è¦½...';
            const orderNumber = orderNumberInput.value.trim() || 'N/A';
            const exportDate = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
            let contentHTML = `<div class="pdf-container"><div class="pdf-header"><h1>åˆ†ç®±æ˜ç´°ç¸½è¡¨</h1><p><strong>è¨‚å–®è™Ÿç¢¼:</strong> ${orderNumber}</p><p><strong>åŒ¯å‡ºæ—¥æœŸ:</strong> ${exportDate}</p></div>`;
            const totalBins = AppState.bins.size;
            Array.from(AppState.bins.values()).forEach((binData, binIndex) => {
                const noteHtml = binData.note ? `<br><strong>å‚™è¨»:</strong> ${binData.note}` : '';
                // ä¿®æ”¹ï¼šå‹•æ…‹ç”¢ç”Ÿç®±è™Ÿæ ¼å¼
                const newTitle = `å…±${totalBins}ç®±-ç¬¬${binIndex + 1}ç®±`;
                contentHTML += `<div class="pdf-bin"><h2>${newTitle}</h2><p><strong>é‹å–®è™Ÿ:</strong> ${binData.tracking || 'æœªå¡«å¯«'}${noteHtml}</p><table><thead><tr><th>å“é …åç¨±</th><th>å•†å“ç·¨è™Ÿ</th><th>åœ‹éš›æ¢ç¢¼</th><th>æ•¸é‡</th></tr></thead><tbody>`;
                if (binData.items.size > 0) { binData.items.forEach(item => { contentHTML += `<tr><td>${item.name}</td><td>${item.code}</td><td>${item.barcode}</td><td>${item.quantity}</td></tr>`; }); } else { contentHTML += `<tr><td colspan="4" style="text-align:center;">æ­¤ç®±ç„¡å•†å“</td></tr>`; }
                contentHTML += `</tbody></table></div>`;
            });
            contentHTML += '</div>';
            const printWindow = window.open('', '_blank');
            if(!printWindow){showToast("ç„¡æ³•æ‰“é–‹é è¦½ï¼Œè«‹æª¢æŸ¥å½ˆçª—å°é–ã€‚", "error"); btn.disabled=false; btn.textContent='åŒ¯å‡º PDF (A4ç¸½è¡¨)'; return;}
            printWindow.document.write(`<!DOCTYPE html><html><head><title>A4åˆ†ç®±è¡¨</title><style>@media print { body { margin: 0; } } body{font-family:sans-serif;font-size:10px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:5px;}.pdf-bin{page-break-inside:avoid;margin-bottom:20px;border:1px solid #eee;padding:10px;}</style></head><body>${contentHTML}</body></html>`);
            printWindow.document.close(); setTimeout(() => { printWindow.focus(); printWindow.print(); }, 500); btn.disabled=false; btn.textContent='åŒ¯å‡º PDF (A4ç¸½è¡¨)';
        }
        function exportA5BoxLabelsPDF() {
             if (AppState.bins.size === 0) { showToast("ç„¡è³‡æ–™ï¼", "error"); return; }
             const btn = document.getElementById('export-a5-pdf-btn'); btn.disabled=true; btn.textContent='æº–å‚™é è¦½...';
             const orderNumber = orderNumberInput.value.trim() || 'N/A';
             let contentHTML = ``;
             const binsArray = Array.from(AppState.bins.values());
             const totalBins = binsArray.length;
             binsArray.forEach((binData, binIndex) => {
                 const itemsArray = Array.from(binData.items.values());
                 const totalPages = Math.max(1, Math.ceil(itemsArray.length / 10));
                 const noteHtml = binData.note ? `<br><strong>å‚™è¨»:</strong> ${binData.note}` : '';
                 for(let i=0; i<totalPages; i++) {
                     const chunk = itemsArray.slice(i*10, (i+1)*10);
                     // ä¿®æ”¹ï¼šæ¨™é¡Œæ ¼å¼èˆ‡åˆ†é é¡¯ç¤º
                     const pageSuffix = totalPages > 1 ? `-ç¬¬${i+1}é ` : '';
                     const newTitle = `å…±${totalBins}ç®±-ç¬¬${binIndex + 1}ç®±${pageSuffix}`;
                     
                     contentHTML += `<div style="page-break-after:always;width:210mm;height:132.5mm;padding:5mm;border:1px dashed #ccc;box-sizing:border-box;"><h1>${newTitle}</h1><p>è¨‚å–®: ${orderNumber}</p><p style="font-size:12px">é‹å–®è™Ÿ: ${binData.tracking || 'ç„¡'}${noteHtml}</p><table><thead><tr><th>å“é …</th><th>æ•¸é‡</th></tr></thead><tbody>`;
                     chunk.forEach(it => { contentHTML += `<tr><td>${it.name}</td><td>${it.quantity}</td></tr>`; });
                     contentHTML += `</tbody></table></div>`;
                 }
             });
             const w = window.open('','_blank'); 
             if(!w){showToast("ç„¡æ³•æ‰“é–‹é è¦½", "error"); btn.disabled=false; btn.textContent='åŒ¯å‡º PDF (A5ç®±è²¼)'; return;}
             w.document.write(`<html><head><style>table{width:100%;border-collapse:collapse}td,th{border:1px solid #ccc}</style></head><body>${contentHTML}</body></html>`); w.document.close(); setTimeout(() => { w.print(); }, 500); btn.disabled=false; btn.textContent='åŒ¯å‡º PDF (A5ç®±è²¼)';
        }

        function exportThermalLabelsPDF() {
            if (AppState.bins.size === 0) { showToast("ç„¡è³‡æ–™ï¼", "error"); return; }
            const btn = document.getElementById('export-thermal-pdf-btn'); btn.disabled=true; btn.textContent = 'æº–å‚™é è¦½...';
            const orderNumber = orderNumberInput.value.trim() || 'N/A';
             let contentHTML = ``;
             const binsArray = Array.from(AppState.bins.values());
             const totalBins = binsArray.length;
             binsArray.forEach((binData, binIndex) => {
                 const itemsArray = Array.from(binData.items.values());
                 const totalPages = Math.max(1, Math.ceil(itemsArray.length / 12));
                 const noteHtml = binData.note ? `<p style="font-size:9pt;margin-top:2px;">å‚™è¨»: ${binData.note}</p>` : '';
                 for(let i=0; i<totalPages; i++) {
                     const chunk = itemsArray.slice(i*12, (i+1)*12);
                     // ä¿®æ”¹ï¼šæ¨™é¡Œæ ¼å¼èˆ‡åˆ†é é¡¯ç¤º
                     const pageSuffix = totalPages > 1 ? `-ç¬¬${i+1}é ` : '';
                     const newTitle = `å…±${totalBins}ç®±-ç¬¬${binIndex + 1}ç®±${pageSuffix}`;

                     contentHTML += `<div style="page-break-after:always;width:100mm;height:150mm;padding:5mm;box-sizing:border-box;"><h3>${newTitle}</h3><p>è¨‚å–®: ${orderNumber}</p><table>`;
                     chunk.forEach(it => { contentHTML += `<tr><td>${it.code}</td><td>${it.quantity}</td></tr>`; });
                     contentHTML += `</table><div style="border-top:1px solid #000;margin-top:5px;padding-top:5px;text-align:center;"><p>é‹å–®è™Ÿ: ${binData.tracking || 'ç„¡'}</p>${noteHtml}</div></div>`;
                 }
             });
            const w = window.open('','_blank'); 
            if(!w){showToast("ç„¡æ³•æ‰“é–‹é è¦½", "error"); btn.disabled=false; btn.textContent='åŒ¯å‡º ç†±æ„Ÿç´™ (10x15)'; return;}
            w.document.write(`<html><head><style>@page{size:100mm 150mm;margin:0}body{margin:0}table{width:100%}td{border:1px solid #ccc}</style></head><body>${contentHTML}</body></html>`); w.document.close(); setTimeout(() => { w.print(); }, 500); btn.disabled=false; btn.textContent='åŒ¯å‡º ç†±æ„Ÿç´™ (10x15)';
        }

        exportBtn.addEventListener('click', exportCSV);
        exportA4PdfBtn.addEventListener('click', exportA4PDF);
        exportA5PdfBtn.addEventListener('click', exportA5BoxLabelsPDF);
        exportThermalPdfBtn.addEventListener('click', exportThermalLabelsPDF);
    }
    setupExports();
    
    function parseCsvRow(row) { return row.split(',').map(c => c.replace(/^"|"$/g, '')); } 
    
    // --- CSV åŒ¯å…¥é‚è¼¯ (æ”¯æ´å¤šç¨®æ ¼å¼) ---
    function handleCsvImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!confirm("ç¢ºå®šé‚„åŸï¼Ÿç›®å‰çš„è³‡æ–™å°‡è¢«æ¸…é™¤ã€‚")) { event.target.value = ''; return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            const rows = e.target.result.split('\n').filter(r => r.trim() !== '');
            if(rows.length <= 1) return;
            AppState.pool.clear(); AppState.bins.clear(); binCounter=0; AppState.lockedBinId=null;
            let maxBin=0;

            const header = parseCsvRow(rows[0]);
            const isNewFormat = header.includes('å‚™è¨»');
            
            for(let i=1; i<rows.length; i++){
                const cols = parseCsvRow(rows[i]); 
                const binName = cols[1];
                if(!binName) continue;
                
                // ä¿®æ”¹ï¼šè§£ææ–°ç‰ˆç®±è™Ÿæ ¼å¼ "å…±Xç®±-ç¬¬Yç®±" -> å– Y
                // ä½¿ç”¨æ­£å‰‡åŒ¹é… "ç¬¬ Y ç®±" (å®¹éŒ¯ç©ºæ ¼)
                const binNumMatch = binName.match(/ç¬¬\s*(\d+)\s*ç®±/);
                // å¦‚æœåŒ¹é…ä¸åˆ° (èˆŠæ ¼å¼)ï¼Œå‰‡é€€å›å°‹æ‰¾ä»»ä½•æ•¸å­—
                const bNum = binNumMatch ? parseInt(binNumMatch[1]) : (parseInt(binName.match(/\d+/)?.[0]||0));
                
                maxBin = Math.max(maxBin, bNum);
                const bId = `bin-${bNum}`;

                let note = '';
                let itemCode = '';
                let itemBarcode = '';
                let itemName = '';
                let itemQty = 0;

                if (isNewFormat) {
                    note = cols[3];
                    itemCode = cols[4];
                    itemBarcode = cols[5];
                    itemName = cols[6];
                    itemQty = parseInt(cols[7]);
                } else {
                    itemCode = cols[3];
                    itemBarcode = cols[4];
                    itemName = cols[5];
                    itemQty = parseInt(cols[6]);
                }

                if(!AppState.bins.has(bId)) {
                    // å¦‚æœé‚„åŸçš„æ˜¯èˆŠæ ¼å¼ï¼Œname å¯èƒ½æœƒæ˜¯ "ç¬¬ X ç®±"ï¼Œé€™è£¡ä¿ç•™åŸå§‹ CSV çš„ name
                    // ä½†å› ç‚º export æ™‚æœƒé‡æ–°è¨ˆç®— "å…± X ç®±"ï¼Œæ‰€ä»¥é€™è£¡å­˜ä»€éº¼ name ä¸å¤ªå½±éŸ¿é¡¯ç¤º
                    AppState.bins.set(bId, { 
                        name: `ç¬¬ ${bNum} ç®±`, // æ¨™æº–åŒ–å…§éƒ¨åç¨±
                        tracking: cols[2], 
                        note: note, 
                        items: new Map(), 
                        completed: false 
                    });
                } else {
                    if(note) AppState.bins.get(bId).note = note;
                }

                if(itemName !== 'æ­¤ç®±ç„¡å•†å“' && itemCode) {
                    AppState.bins.get(bId).items.set(itemCode, { code: itemCode, barcode: itemBarcode, name: itemName, quantity: itemQty });
                }
            }
            binCounter=maxBin;
            render(); saveStateToLocalStorage(); showToast("é‚„åŸæˆåŠŸ", "success");
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    importCsvInput.addEventListener('change', handleCsvImport);

    function showToast(message, type = 'info') {
        const toast = document.createElement('div'); toast.className = `toast-notification ${type}`; toast.textContent = message;
        document.body.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }
    function saveStateToLocalStorage() {
        localStorage.setItem('binningToolState_v72', JSON.stringify({
            pool: Array.from(AppState.pool.entries()),
            bins: Array.from(AppState.bins.entries()).map(([k,v]) => [k, {...v, items: Array.from(v.items.entries())}]),
            binCounter, orderNumber: orderNumberInput.value, lockedBinId: AppState.lockedBinId
        }));
    }
    function loadStateFromLocalStorage() {
        const s = localStorage.getItem('binningToolState_v72');
        if(!s) return;
        const d = JSON.parse(s);
        AppState.pool = new Map(d.pool);
        AppState.bins = new Map(d.bins.map(([k,v]) => [k, {...v, items: new Map(v.items), note: v.note || ''}])); 
        binCounter = d.binCounter; orderNumberInput.value = d.orderNumber; AppState.lockedBinId = d.lockedBinId;
        render();
    }
    orderNumberInput.addEventListener('input', saveStateToLocalStorage);
    document.addEventListener('DOMContentLoaded', loadStateFromLocalStorage);
</script>
</body>
</html>
